name: CI/CD Pipeline

on:
  push:
    branches: [main, develop, release/*]
    tags: ['v*']
  pull_request:
    branches: [main, develop]

env:
  GO_VERSION: '1.22'
  REGISTRY: docker.io  # 使用 Docker Hub（如需更换为 Harbor 或阿里云，修改此处）
  IMAGE_PREFIX: mzlone  # 你的 Docker Hub 用户名（确保与 HARBOR_USERNAME 匹配）

jobs:
  # 代码检查与测试
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install dependencies
        run: go mod download

      # TODO: Re-enable after fixing lint issues (see docs/LINT_FIX_REPORT.md)
      # - name: Run golangci-lint
      #   uses: golangci/golangci-lint-action@v4
      #   with:
      #     version: latest
      #     args: --timeout=5m

      - name: Run tests
        run: |
          go test -coverprofile=coverage.out -covermode=atomic ./...
          go tool cover -html=coverage.out -o coverage.html

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          flags: unittests
        continue-on-error: true  # Don't fail if codecov upload fails

      # TODO: Configure SonarQube server before enabling
      # - name: SonarQube Scan
      #   uses: sonarsource/sonarqube-scan-action@master
      #   env:
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      #     SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

  # 构建镜像
  build-images:
    needs: lint-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    strategy:
      matrix:
        service:
          - usercenter-api
          - usercenter-rpc
          - travel-api
          - travel-rpc
          - order-api
          - order-rpc
          - payment-api
          - payment-rpc
          - order-mq
          - mqueue-job
          - mqueue-scheduler

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Harbor
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deploy/dockerfile/${{ matrix.service }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}:main
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true  # Don't fail build if scan has issues

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true  # Don't fail build if upload fails

  # 部署到开发环境
  # 通过 Cloudflare Tunnel 访问本地 Docker Desktop K8s 集群
  # ⚠️ 仅用于学习和验证 CI/CD 流程，生产环境请使用云端 K8s
  # 配置说明: docs/K8S_DEPLOYMENT_TUNNEL.md
  deploy-dev:
    needs: build-images
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: development
      url: https://dev-api.flashsale.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG_DEV }}" | base64 -d > $HOME/.kube/config

      - name: Verify K8s connection
        run: |
          echo "Testing connection to K8s cluster..."

          # Extract API server URL from kubeconfig
          API_SERVER=$(kubectl config view --minify -o jsonpath='{.clusters[0].cluster.server}')
          echo "K8s API Server: $API_SERVER"

          # Test network connectivity
          echo "Testing network connectivity..."
          curl -k -v --connect-timeout 10 "$API_SERVER/version" || echo "Warning: Cannot reach API server"

          # Test kubectl (--short flag removed in kubectl v1.28+)
          kubectl version --client --request-timeout=10s || echo "Warning: kubectl version check failed"
          kubectl cluster-info --request-timeout=10s || echo "Warning: cluster-info failed"

          # Show current context
          kubectl config current-context

      - name: Deploy with Helm
        run: |
          # Set kubectl timeout to prevent hanging
          export KUBECTL_TIMEOUT=30s

          # Deploy with increased timeout
          helm upgrade --install flashsale ./deploy/helm \
            --namespace flashsale-dev \
            --create-namespace \
            --set image.tag=${{ github.sha }} \
            --set env=dev \
            --values ./deploy/helm/values-dev.yaml \
            --wait --timeout 10m \
            --debug
        continue-on-error: true

      - name: Diagnose failed deployments
        if: failure() || success()
        run: |
          echo "=== Checking all pods status ==="
          kubectl get pods -n flashsale-dev -o wide

          echo ""
          echo "=== Checking failed/pending pods details ==="
          kubectl get pods -n flashsale-dev --field-selector=status.phase!=Running -o wide

          echo ""
          echo "=== Pod Events ==="
          kubectl get events -n flashsale-dev --sort-by='.lastTimestamp' | tail -50

          echo ""
          echo "=== Checking mqueue-job specifically ==="
          kubectl describe deployment mqueue-job -n flashsale-dev || true
          kubectl describe pod -l app=mqueue-job -n flashsale-dev || true

          echo ""
          echo "=== mqueue-job Pod Logs ==="
          kubectl logs -l app=mqueue-job -n flashsale-dev --tail=100 --all-containers=true || echo "No logs available"

          echo ""
          echo "=== Checking all deployments ==="
          kubectl get deployments -n flashsale-dev

      - name: Run smoke tests
        run: |
          kubectl wait --for=condition=ready pod -l app=flashsale -n flashsale-dev --timeout=300s
          # 这里添加冒烟测试脚本
          # curl -f https://dev-api.flashsale.com/health || exit 1

      - name: Notify DingTalk
        if: always()
        uses: zcong1993/actions-ding@master
        with:
          dingToken: ${{ secrets.DINGTALK_TOKEN }}
          body: |
            {
              "msgtype": "markdown",
              "markdown": {
                "title": "部署通知",
                "text": "### 开发环境部署\n- 状态: ${{ job.status }}\n- 分支: ${{ github.ref_name }}\n- Commit: ${{ github.sha }}\n- 操作人: ${{ github.actor }}"
              }
            }

  # 部署到生产环境（需要手动审批）
  # TODO: 需要配置真正的远程 K8s 集群后再启用
  # 当前 Docker Desktop 本地集群无法从 GitHub Actions 访问
  # 详见: docs/K8S_DEPLOYMENT_ISSUE.md
  # deploy-prod:
  #   needs: build-images
  #   runs-on: ubuntu-latest
  #   if: startsWith(github.ref, 'refs/tags/v')
  #   environment:
  #     name: production
  #     url: https://api.flashsale.com
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup kubectl & Helm
  #       uses: azure/setup-kubectl@v4
  #
  #     - name: Setup Helm
  #       uses: azure/setup-helm@v4
  #
  #     - name: Configure kubeconfig
  #       run: |
  #         mkdir -p $HOME/.kube
  #         echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > $HOME/.kube/config
  #
  #     - name: Deploy with Helm (Rolling Update)
  #       run: |
  #         helm upgrade --install flashsale ./deploy/helm \
  #           --namespace flashsale-prod \
  #           --create-namespace \
  #           --set image.tag=${{ github.ref_name }} \
  #           --set env=prod \
  #           --values ./deploy/helm/values-prod.yaml \
  #           --wait --timeout 10m
  #
  #     - name: Health check
  #       run: |
  #         kubectl wait --for=condition=ready pod -l app=flashsale -n flashsale-prod --timeout=600s
  #         curl -f https://api.flashsale.com/health || exit 1
  #
  #     - name: Create release
  #       uses: actions/create-release@v1
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #       with:
  #         tag_name: ${{ github.ref_name }}
  #         release_name: Release ${{ github.ref_name }}
  #         draft: false
  #         prerelease: false
  #
  #     - name: Notify success
  #       if: success()
  #       uses: zcong1993/actions-ding@master
  #       with:
  #         dingToken: ${{ secrets.DINGTALK_TOKEN }}
  #         body: |
  #           {
  #             "msgtype": "markdown",
  #             "markdown": {
  #               "title": "生产部署成功",
  #               "text": "### 生产环境部署成功 ✅\n- 版本: ${{ github.ref_name }}\n- 部署人: ${{ github.actor }}\n- 时间: $(date)"
  #             }
  #           }
